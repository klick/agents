{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Agents Return Requests" %}
{% set selectedSubnavItem = "control" %}

{% block content %}
  <h1>Return Requests</h1>
  <p class="text-sm text-muted">This page is for internal refund decisions after return intake and inspection. Customer returns can proceed as usual; this queue controls whether refunds are approved and recorded.</p>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Flow in 3 steps</h2>
    <ol style="margin: 0 0 0 18px;">
      <li>An agent/integration creates a return request when a refund needs review.</li>
      <li>A human approves or rejects the request.</li>
      <li>An approved action is run once, with duplicate protection.</li>
    </ol>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Now</h2>
    <p>
      <span class="status {{ agentsEnabled ? 'enabled' : 'disabled' }}"></span>
      <strong>{{ agentsEnabled ? 'Enabled' : 'Disabled' }}</strong>
      <span class="text-muted">(source: {{ agentsEnabledSource == 'env' ? 'environment variable' : 'plugin settings' }})</span>
    </p>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 12px;">
      <div class="border rounded p-2">
        <div class="light">Waiting for decision</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.approvalsPending|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">Runs blocked</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.executionsBlocked|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">Runs completed</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.executionsSucceeded|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">Active rules</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.policies|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">Activity entries</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.auditEvents|default(0) }}</strong></div>
      </div>
    </div>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Waiting for Decision</h2>
    {% if controlPendingApprovals|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>Request #</th>
          <th>Action</th>
          <th>Rule</th>
          <th>Requested</th>
          <th>Reason</th>
          <th>Decision</th>
        </tr>
        </thead>
        <tbody>
        {% for approval in controlPendingApprovals %}
          {% set policy = approval.policy ?? null %}
          <tr>
            <td>#{{ approval.id }}</td>
            <td>
              <code>{{ approval.actionType }}</code><br>
              <span class="light">{{ approval.actionRef ?: 'no case reference' }}</span>
            </td>
            <td>
              {% if policy %}
                <span class="badge">RISK {{ policy.riskLevel|upper }}</span>
                <div class="light">Rule: <code>{{ policy.handle }}</code></div>
                <div class="light">Approval required: {{ policy.requiresApproval ? 'yes' : 'no' }}</div>
              {% else %}
                <span class="light">Default rule</span>
              {% endif %}
            </td>
            <td>
              <div>{{ approval.requestedBy }}</div>
              <div class="light">{{ approval.dateCreated ?: 'n/a' }}</div>
            </td>
            <td>{{ approval.reason ?: 'n/a' }}</td>
            <td>
              {% if canManageApprovals %}
                <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Approve request #{{ approval.id }} ({{ approval.actionType }})?" style="margin-bottom: 6px;">
                  {{ csrfInput() }}
                  {{ actionInput('agents/dashboard/decide-control-approval') }}
                  {{ redirectInput('agents/control') }}
                  <input type="hidden" name="approvalId" value="{{ approval.id }}">
                  <input type="hidden" name="decision" value="approved">
                  <input type="text" name="decisionReason" placeholder="Optional note" style="width: 100%; margin-bottom: 4px;">
                  <button class="btn" type="submit">Approve</button>
                </form>
                <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Reject request #{{ approval.id }} ({{ approval.actionType }})?">
                  {{ csrfInput() }}
                  {{ actionInput('agents/dashboard/decide-control-approval') }}
                  {{ redirectInput('agents/control') }}
                  <input type="hidden" name="approvalId" value="{{ approval.id }}">
                  <input type="hidden" name="decision" value="rejected">
                  <input type="text" name="decisionReason" placeholder="Reason for rejection" style="width: 100%; margin-bottom: 4px;">
                  <button class="btn" type="submit">Reject</button>
                </form>
              {% else %}
                <span class="light">Read-only</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No requests are waiting for a decision.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Runs That Need Follow-up</h2>
    {% if controlAttentionExecutions|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>Run #</th>
          <th>Action</th>
          <th>Status</th>
          <th>Rule</th>
          <th>Issue</th>
        </tr>
        </thead>
        <tbody>
        {% for execution in controlAttentionExecutions %}
          {% set policy = execution.policy ?? null %}
          <tr>
            <td>#{{ execution.id }}</td>
            <td>
              <code>{{ execution.actionType }}</code><br>
              <span class="light">{{ execution.actionRef ?: 'no case reference' }}</span>
            </td>
            <td><strong>{{ execution.status }}</strong></td>
            <td>
              {% if policy %}
                <span class="badge">RISK {{ policy.riskLevel|upper }}</span>
                <div class="light">Rule: <code>{{ policy.handle }}</code></div>
              {% else %}
                <span class="light">Default rule</span>
              {% endif %}
            </td>
            <td>{{ execution.errorMessage ?: 'Check rule/approval requirements and retry.' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No blocked or failed runs in this view.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Create Request Manually (Fallback)</h2>
    <p class="light">Recommended flow: agents create requests via API. Use this form only if you need a manual fallback.</p>

    {% if canManageApprovals and allowCpApprovalRequests %}
      <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Create this return request?">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/request-control-approval') }}
        {{ redirectInput('agents/control') }}

        {{ forms.textField({
          label: 'Action name',
          instructions: 'Internal action key. Example: returns.exception.refund',
          name: 'actionType',
          required: true,
          placeholder: 'returns.exception.refund',
        }) }}

        {{ forms.textField({
          label: 'Case reference',
          instructions: 'Optional order/return/case reference.',
          name: 'actionRef',
          placeholder: 'order-12345:return-998',
        }) }}

        {{ forms.textField({
          label: 'Duplicate protection key',
          instructions: 'Optional but recommended. Reuse prevents accidental duplicates.',
          name: 'idempotencyKey',
          placeholder: 'approval-returns-12345-v1',
        }) }}

        {{ forms.textareaField({
          label: 'Reason for review',
          name: 'reason',
          rows: 2,
          placeholder: 'High-value return outside normal threshold.',
        }) }}

        <h3 class="h5">Request Details</h3>
        {{ forms.textField({
          label: 'Order number / ID',
          name: 'payloadOrderId',
          placeholder: '12345',
        }) }}
        {{ forms.textField({
          label: 'Return number / ID',
          name: 'payloadReturnId',
          placeholder: '998',
        }) }}
        {{ forms.textField({
          label: 'Customer ID',
          name: 'payloadCustomerId',
          placeholder: 'cust_001',
        }) }}
        {{ forms.textField({
          label: 'Approver note',
          name: 'payloadNote',
          placeholder: 'Photos are unclear, needs manual decision.',
        }) }}

        <h3 class="h5">Source Tracking</h3>
        {{ forms.textField({
          label: 'Source',
          name: 'metadataSource',
          placeholder: 'cp-manual',
        }) }}
        {{ forms.textField({
          label: 'Team/Channel',
          name: 'metadataChannel',
          placeholder: 'ops',
        }) }}

        <details style="margin-bottom: 12px;">
          <summary><strong>Advanced JSON (optional)</strong></summary>
          <div style="margin-top: 8px;">
            {{ forms.textareaField({
              label: 'Payload JSON',
              instructions: 'Merged with guided fields. Duplicate keys in JSON take precedence.',
              name: 'payloadJson',
              rows: 4,
              value: '{}',
            }) }}

            {{ forms.textareaField({
              label: 'Metadata JSON',
              instructions: 'Merged with guided fields. Duplicate keys in JSON take precedence.',
              name: 'metadataJson',
              rows: 3,
              value: '{}',
            }) }}
          </div>
        </details>

        <button class="btn submit" type="submit">Create Request</button>
      </form>
    {% elseif canManageApprovals %}
      <p class="warning">Manual creation is off (agent-first mode).</p>
      <p class="light">Use your integration to call <code>POST /agents/v1/control/approvals/request</code>.</p>
    {% else %}
      <p class="warning">You do not have permission to create return requests.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Run an Approved Action</h2>
    {% if canExecuteActions %}
      <p class="light">This checks rule + approval requirements first and blocks invalid runs automatically.</p>

      <form method="post" accept-charset="UTF-8" id="control-execute-form" class="js-confirm-form" data-confirm-message="">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/execute-control-action') }}
        {{ redirectInput('agents/control') }}

        {{ forms.textField({
          label: 'Action name',
          id: 'execute-action-type',
          name: 'actionType',
          required: true,
          placeholder: 'returns.exception.refund',
        }) }}

        {{ forms.textField({
          label: 'Case reference',
          name: 'actionRef',
          placeholder: 'order-12345:return-998',
        }) }}

        {{ forms.textField({
          label: 'Approved request #',
          id: 'execute-approval-id',
          name: 'approvalId',
          instructions: 'Required when the matching rule needs approval.',
          placeholder: '123',
        }) }}

        {{ forms.textField({
          label: 'Duplicate protection key',
          name: 'idempotencyKey',
          required: true,
          placeholder: 'exec-returns-12345-v1',
        }) }}

        <h3 class="h5">Run Details</h3>
        {{ forms.textField({
          label: 'Order number / ID',
          name: 'payloadOrderId',
          placeholder: '12345',
        }) }}
        {{ forms.textField({
          label: 'Return number / ID',
          name: 'payloadReturnId',
          placeholder: '998',
        }) }}
        {{ forms.textField({
          label: 'Reason code (optional)',
          name: 'payloadReasonCode',
          placeholder: 'DAMAGED_ITEM',
        }) }}
        {{ forms.textField({
          label: 'Operator note',
          name: 'payloadOperatorNote',
          placeholder: 'Refund approved after manual check.',
        }) }}

        <details style="margin-bottom: 12px;">
          <summary><strong>Advanced JSON (optional)</strong></summary>
          <div style="margin-top: 8px;">
            {{ forms.textareaField({
              label: 'Payload JSON',
              instructions: 'Merged with guided fields. Duplicate keys in JSON take precedence.',
              name: 'payloadJson',
              rows: 4,
              value: '{}',
            }) }}
          </div>
        </details>

        <div id="execute-policy-hint" class="light" style="margin-bottom: 8px;"></div>
        <button class="btn submit" id="execute-submit" type="submit">Run Action</button>
      </form>
    {% else %}
      <p class="warning">You do not have permission to run actions.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Rules</h2>

    {% if controlPolicies|length %}
      <table class="data fullwidth" style="margin-bottom: 12px;">
        <thead>
        <tr>
          <th>Rule key</th>
          <th>Matches action</th>
          <th>Risk</th>
          <th>Approval required</th>
          <th>Active</th>
        </tr>
        </thead>
        <tbody>
        {% for policy in controlPolicies %}
          <tr>
            <td><code>{{ policy.handle }}</code><br><span class="light">{{ policy.displayName }}</span></td>
            <td><code>{{ policy.actionPattern }}</code></td>
            <td>{{ policy.riskLevel|upper }}</td>
            <td>{{ policy.requiresApproval ? 'yes' : 'no' }}</td>
            <td>{{ policy.enabled ? 'yes' : 'no' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No rules configured yet.</p>
    {% endif %}

    {% if canManagePolicies %}
      <details>
        <summary><strong>Create or update a rule</strong></summary>
        <div style="margin-top: 8px;">
          <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Save this rule?">
            {{ csrfInput() }}
            {{ actionInput('agents/dashboard/upsert-control-policy') }}
            {{ redirectInput('agents/control') }}

            {{ forms.textField({
              label: 'Rule key',
              instructions: 'Stable machine key for this rule.',
              name: 'handle',
              required: true,
              placeholder: 'returns-exception-high-risk',
            }) }}

            {{ forms.textField({
              label: 'Rule name',
              name: 'displayName',
              placeholder: 'Returns Exception High Risk',
            }) }}

            {{ forms.textField({
              label: 'Action match pattern',
              instructions: 'Wildcard pattern, for example: returns.exception.*',
              name: 'actionPattern',
              required: true,
              placeholder: 'returns.exception.*',
            }) }}

            {{ forms.selectField({
              label: 'Risk level',
              name: 'riskLevel',
              options: [
                {label: 'low', value: 'low'},
                {label: 'medium', value: 'medium'},
                {label: 'high', value: 'high'},
                {label: 'critical', value: 'critical'},
              ],
              value: 'medium',
            }) }}

            <div style="margin-bottom: 8px;">
              <input type="hidden" name="requiresApproval" value="0">
              <label><input type="checkbox" name="requiresApproval" value="1" checked> Require approval</label>
            </div>

            <div style="margin-bottom: 8px;">
              <input type="hidden" name="enabled" value="0">
              <label><input type="checkbox" name="enabled" value="1" checked> Rule is active</label>
            </div>

            <details style="margin-bottom: 12px;">
              <summary><strong>Advanced rule JSON</strong></summary>
              <div style="margin-top: 8px;">
                {{ forms.textareaField({
                  label: 'Advanced config JSON',
                  instructions: 'Optional advanced values, for example: {"requiredScope":"control:actions:execute"}.',
                  name: 'configJson',
                  rows: 4,
                  value: '{"requiredScope":"control:actions:execute"}',
                }) }}
              </div>
            </details>

            <button class="btn submit" type="submit">Save Rule</button>
          </form>
        </div>
      </details>
    {% else %}
      <p class="warning">You do not have permission to manage rules.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Activity Log</h2>
    {% if controlAuditEvents|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Event</th>
          <th>Actor</th>
          <th>Summary</th>
        </tr>
        </thead>
        <tbody>
        {% for event in controlAuditEvents %}
          <tr>
            <td>{{ event.dateCreated ?: 'n/a' }}</td>
            <td><code>{{ event.category }}</code></td>
            <td>{{ event.action }} ({{ event.outcome }})</td>
            <td>{{ event.actorType }} / {{ event.actorId ?: 'n/a' }}</td>
            <td>{{ event.summary ?: 'n/a' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No history events recorded yet.</p>
    {% endif %}

    <details style="margin-top: 12px;">
      <summary><strong>Technical Data (Advanced)</strong></summary>
      <pre class="border rounded p-3" style="margin-top: 8px;">{{ controlSnapshotJson }}</pre>
    </details>
  </div>

  {% if canManageApprovals or canExecuteActions or canManagePolicies %}
    {% js %}
      (() => {
        const confirmForms = document.querySelectorAll('.js-confirm-form');
        confirmForms.forEach((form) => {
          form.addEventListener('submit', (event) => {
            const customMessage = form.getAttribute('data-confirm-message') || 'Are you sure?';
            if (!window.confirm(customMessage)) {
              event.preventDefault();
            }
          });
        });

        const executeForm = document.getElementById('control-execute-form');
        if (!executeForm) {
          return;
        }

        const actionTypeInput = document.getElementById('execute-action-type');
        const approvalIdInput = document.getElementById('execute-approval-id');
        const executeButton = document.getElementById('execute-submit');
        const hintNode = document.getElementById('execute-policy-hint');

        if (!actionTypeInput || !approvalIdInput || !executeButton || !hintNode) {
          return;
        }

        const policies = {{ controlPolicies|json_encode|raw }};
        const approvedApprovalsById = {{ controlApprovedApprovalsById|json_encode|raw }};

        const escapeRegex = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const matchesPattern = (actionType, pattern) => {
          if (!pattern || pattern === '*') {
            return true;
          }

          const regex = '^' + pattern.split('*').map(escapeRegex).join('.*') + '$';
          return new RegExp(regex).test(actionType);
        };

        const resolvePolicy = (actionType) => {
          let best = null;
          let bestLen = -1;

          policies.forEach((policy) => {
            const pattern = String(policy.actionPattern || '').trim();
            if (!pattern) {
              return;
            }

            if (!matchesPattern(actionType, pattern)) {
              return;
            }

            if (pattern.length > bestLen) {
              best = policy;
              bestLen = pattern.length;
            }
          });

          if (best) {
            return best;
          }

          return {
            handle: 'default-control-policy',
            riskLevel: 'high',
            requiresApproval: true,
            enabled: true,
          };
        };

        const setExecuteState = () => {
          const actionType = String(actionTypeInput.value || '').trim();
          const approvalIdRaw = String(approvalIdInput.value || '').trim();

          if (!actionType) {
            executeButton.disabled = true;
            hintNode.textContent = 'Enter an action name to validate this run.';
            executeForm.setAttribute('data-confirm-message', '');
            return;
          }

          const policy = resolvePolicy(actionType);
          const risk = String(policy.riskLevel || 'unknown').toUpperCase();
          const requiresApproval = Boolean(policy.requiresApproval);
          const policyEnabled = Boolean(policy.enabled);

          if (!policyEnabled) {
            executeButton.disabled = true;
            hintNode.textContent = `Rule ${policy.handle || 'default'} is disabled. This run is blocked.`;
            executeForm.setAttribute('data-confirm-message', '');
            return;
          }

          if (requiresApproval) {
            if (!approvalIdRaw) {
              executeButton.disabled = true;
              hintNode.textContent = `Risk ${risk}. This rule needs an approved request number.`;
              executeForm.setAttribute('data-confirm-message', '');
              return;
            }

            const approvalId = Number.parseInt(approvalIdRaw, 10);
            if (!Number.isInteger(approvalId) || !approvedApprovalsById[approvalId]) {
              executeButton.disabled = true;
              hintNode.textContent = `Risk ${risk}. Request number must point to an approved request.`;
              executeForm.setAttribute('data-confirm-message', '');
              return;
            }

            const approvedActionType = String(approvedApprovalsById[approvalId] || '');
            if (approvedActionType !== actionType) {
              executeButton.disabled = true;
              hintNode.textContent = `Risk ${risk}. Request #${approvalId} is for ${approvedActionType}, not ${actionType}.`;
              executeForm.setAttribute('data-confirm-message', '');
              return;
            }
          }

          executeButton.disabled = false;
          hintNode.textContent = `Ready. Risk ${risk}. Approval ${requiresApproval ? 'required and validated' : 'not required'} by rule ${policy.handle || 'default-control-policy'}.`;

          const approvalSegment = requiresApproval
            ? ` Request #${approvalIdRaw} has been validated.`
            : ' This rule does not require approval.';
          executeForm.setAttribute('data-confirm-message', `Run ${actionType} with risk ${risk}?${approvalSegment}`);
        };

        actionTypeInput.addEventListener('input', setExecuteState);
        approvalIdInput.addEventListener('input', setExecuteState);
        setExecuteState();
      })();
    {% endjs %}
  {% endif %}
{% endblock %}
