{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Agents Refund Approvals" %}
{% set selectedSubnavItem = "control" %}

{% block content %}
  <h1>Refund Approvals</h1>
  <p class="text-sm text-muted">Simple flow: after return intake/inspection, an agent creates a refund-approval request, a human approves/rejects it, then an approved refund action can run.</p>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">How this works</h2>
    <ol style="margin: 0 0 0 18px;">
      <li>Return is initiated and physically handled as usual.</li>
      <li>Agent sends a refund-approval request for internal decision.</li>
      <li>You approve or reject it, then approved refund actions can run safely (with duplicate protection).</li>
    </ol>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">What Needs Attention</h2>
    <p>
      <span class="status {{ agentsEnabled ? 'enabled' : 'disabled' }}"></span>
      <strong>{{ agentsEnabled ? 'Enabled' : 'Disabled' }}</strong>
      <span class="text-muted">(source: {{ agentsEnabledSource == 'env' ? 'environment variable' : 'plugin settings' }})</span>
    </p>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 12px;">
      <div class="border rounded p-2">
        <div class="light">Pending refund approvals</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.approvalsPending|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">Blocked refund runs</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.executionsBlocked|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">Successful refund runs</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.executionsSucceeded|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">Active rules</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.policies|default(0) }}</strong></div>
      </div>
      <div class="border rounded p-2">
        <div class="light">History entries</div>
        <div style="font-size: 24px;"><strong>{{ controlSummary.auditEvents|default(0) }}</strong></div>
      </div>
    </div>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Pending Refund Approvals</h2>
    {% if controlPendingApprovals|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>Request</th>
          <th>Refund Action</th>
          <th>Rule</th>
          <th>Requested By</th>
          <th>Why</th>
          <th>Decide</th>
        </tr>
        </thead>
        <tbody>
        {% for approval in controlPendingApprovals %}
          {% set policy = approval.policy ?? null %}
          <tr>
            <td>#{{ approval.id }}</td>
            <td>
              <code>{{ approval.actionType }}</code><br>
              <span class="light">{{ approval.actionRef ?: 'none' }}</span>
            </td>
            <td>
              {% if policy %}
                <span class="badge">IMPACT {{ policy.riskLevel|upper }}</span>
                <div class="light">Rule: <code>{{ policy.handle }}</code></div>
                <div class="light">Needs approval: {{ policy.requiresApproval ? 'yes' : 'no' }}</div>
              {% else %}
                <span class="light">Default rule</span>
              {% endif %}
            </td>
            <td>
              <div>{{ approval.requestedBy }}</div>
              <div class="light">{{ approval.dateCreated ?: 'n/a' }}</div>
            </td>
            <td>{{ approval.reason ?: 'n/a' }}</td>
            <td>
              {% if canManageApprovals %}
                <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Approve request #{{ approval.id }} for {{ approval.actionType }}?" style="margin-bottom: 6px;">
                  {{ csrfInput() }}
                  {{ actionInput('agents/dashboard/decide-control-approval') }}
                  {{ redirectInput('agents/control') }}
                  <input type="hidden" name="approvalId" value="{{ approval.id }}">
                  <input type="hidden" name="decision" value="approved">
                  <input type="text" name="decisionReason" placeholder="Why approve?" style="width: 100%; margin-bottom: 4px;">
                  <button class="btn" type="submit">Approve</button>
                </form>
                <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Reject request #{{ approval.id }} for {{ approval.actionType }}?">
                  {{ csrfInput() }}
                  {{ actionInput('agents/dashboard/decide-control-approval') }}
                  {{ redirectInput('agents/control') }}
                  <input type="hidden" name="approvalId" value="{{ approval.id }}">
                  <input type="hidden" name="decision" value="rejected">
                  <input type="text" name="decisionReason" placeholder="Why reject?" style="width: 100%; margin-bottom: 4px;">
                  <button class="btn" type="submit">Reject</button>
                </form>
              {% else %}
                <span class="light">Read-only</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>Nothing is waiting for approval.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Refund Runs That Need Attention</h2>
    {% if controlAttentionExecutions|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>Run</th>
          <th>Refund Action</th>
          <th>State</th>
          <th>Rule</th>
          <th>What Went Wrong</th>
        </tr>
        </thead>
        <tbody>
        {% for execution in controlAttentionExecutions %}
          {% set policy = execution.policy ?? null %}
          <tr>
            <td>#{{ execution.id }}</td>
            <td>
              <code>{{ execution.actionType }}</code><br>
              <span class="light">{{ execution.actionRef ?: 'none' }}</span>
            </td>
            <td><strong>{{ execution.status }}</strong></td>
            <td>
              {% if policy %}
                <span class="badge">IMPACT {{ policy.riskLevel|upper }}</span>
                <div class="light">Rule: <code>{{ policy.handle }}</code></div>
              {% else %}
                <span class="light">Default rule</span>
              {% endif %}
            </td>
            <td>{{ execution.errorMessage ?: 'Check rule or approval requirements.' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No blocked or failed runs in this view.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Create Refund Approval (Manual)</h2>
    {% if canManageApprovals and allowCpApprovalRequests %}
      <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Send this request for approval?">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/request-control-approval') }}
        {{ redirectInput('agents/control') }}

        {{ forms.textField({
          label: 'Refund Action Name',
          instructions: 'Machine name for the refund action. Example: returns.exception.refund.',
          name: 'actionType',
          required: true,
          placeholder: 'returns.exception.refund',
        }) }}

        {{ forms.textField({
          label: 'Case Reference',
          instructions: 'Optional business reference (order, return, case, ticket).',
          name: 'actionRef',
          placeholder: 'order-12345:return-998',
        }) }}

        {{ forms.textField({
          label: 'Duplicate Protection Key',
          instructions: 'Optional but recommended. Reusing this key avoids accidental duplicate requests.',
          name: 'idempotencyKey',
          placeholder: 'approval-returns-12345-v1',
        }) }}

        {{ forms.textareaField({
          label: 'Why This Needs Approval',
          name: 'reason',
          rows: 2,
          placeholder: 'High-value return exceeded policy threshold.',
        }) }}

        <h3 class="h5">Details</h3>
        {{ forms.textField({
          label: 'Order Number/ID',
          name: 'payloadOrderId',
          placeholder: '12345',
        }) }}
        {{ forms.textField({
          label: 'Return Number/ID',
          name: 'payloadReturnId',
          placeholder: '998',
        }) }}
        {{ forms.textField({
          label: 'Customer ID',
          name: 'payloadCustomerId',
          placeholder: 'cust_001',
        }) }}
        {{ forms.textField({
          label: 'Note For Approver',
          name: 'payloadNote',
          placeholder: 'Photos unclear, requesting manual review.',
        }) }}

        <h3 class="h5">Tracking</h3>
        {{ forms.textField({
          label: 'Source',
          name: 'metadataSource',
          placeholder: 'cp-manual',
        }) }}
        {{ forms.textField({
          label: 'Channel/Team',
          name: 'metadataChannel',
          placeholder: 'ops',
        }) }}

        <details style="margin-bottom: 12px;">
          <summary><strong>Advanced JSON (optional)</strong></summary>
          <div style="margin-top: 8px;">
            {{ forms.textareaField({
              label: 'Payload JSON',
              instructions: 'Merged with guided payload fields. JSON values override guided keys when duplicated.',
              name: 'payloadJson',
              rows: 4,
              value: '{}',
            }) }}

            {{ forms.textareaField({
              label: 'Metadata JSON',
              instructions: 'Merged with guided metadata fields. JSON values override guided keys when duplicated.',
              name: 'metadataJson',
              rows: 3,
              value: '{}',
            }) }}
          </div>
        </details>

        <button class="btn submit" type="submit">Send For Approval</button>
      </form>
    {% elseif canManageApprovals %}
      <p class="warning">Manual request form is turned off (agent-first mode).</p>
      <p class="light">Use your agent/integration to call <code>POST /agents/v1/control/approvals/request</code> for refund approvals.</p>
    {% else %}
      <p class="warning">You do not have permission to create refund approvals.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Run Approved Refund Action</h2>
    {% if canExecuteActions %}
      <p class="light">This checks rules and approvals before sending. Invalid runs are blocked automatically.</p>

      <form method="post" accept-charset="UTF-8" id="control-execute-form" class="js-confirm-form" data-confirm-message="">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/execute-control-action') }}
        {{ redirectInput('agents/control') }}

        {{ forms.textField({
          label: 'Refund Action Name',
          id: 'execute-action-type',
          name: 'actionType',
          required: true,
          placeholder: 'returns.exception.refund',
        }) }}

        {{ forms.textField({
          label: 'Case Reference',
          name: 'actionRef',
          placeholder: 'order-12345:return-998',
        }) }}

        {{ forms.textField({
          label: 'Approved Request Number',
          id: 'execute-approval-id',
          name: 'approvalId',
          instructions: 'If the rule requires approval, enter the approved request number.',
          placeholder: '123',
        }) }}

        {{ forms.textField({
          label: 'Duplicate Protection Key',
          name: 'idempotencyKey',
          required: true,
          placeholder: 'exec-returns-12345-v1',
        }) }}

        <h3 class="h5">Details</h3>
        {{ forms.textField({
          label: 'Order Number/ID',
          name: 'payloadOrderId',
          placeholder: '12345',
        }) }}
        {{ forms.textField({
          label: 'Return Number/ID',
          name: 'payloadReturnId',
          placeholder: '998',
        }) }}
        {{ forms.textField({
          label: 'Reason Code (Optional)',
          name: 'payloadReasonCode',
          placeholder: 'DAMAGED_ITEM',
        }) }}
        {{ forms.textField({
          label: 'Operator Note',
          name: 'payloadOperatorNote',
          placeholder: 'Refund approved after manual check.',
        }) }}

        <details style="margin-bottom: 12px;">
          <summary><strong>Advanced JSON (optional)</strong></summary>
          <div style="margin-top: 8px;">
            {{ forms.textareaField({
              label: 'Payload JSON',
              instructions: 'Merged with guided payload fields. JSON values override guided keys when duplicated.',
              name: 'payloadJson',
              rows: 4,
              value: '{}',
            }) }}
          </div>
        </details>

        <div id="execute-policy-hint" class="light" style="margin-bottom: 8px;"></div>
        <button class="btn submit" id="execute-submit" type="submit">Run Action</button>
      </form>
    {% else %}
      <p class="warning">You do not have permission to execute actions.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Refund Rules</h2>

    {% if controlPolicies|length %}
      <table class="data fullwidth" style="margin-bottom: 12px;">
        <thead>
        <tr>
          <th>Rule</th>
          <th>Matches Workflow</th>
          <th>Impact</th>
          <th>Needs Approval</th>
          <th>Active</th>
        </tr>
        </thead>
        <tbody>
        {% for policy in controlPolicies %}
          <tr>
            <td><code>{{ policy.handle }}</code><br><span class="light">{{ policy.displayName }}</span></td>
            <td><code>{{ policy.actionPattern }}</code></td>
            <td>{{ policy.riskLevel|upper }}</td>
            <td>{{ policy.requiresApproval ? 'yes' : 'no' }}</td>
            <td>{{ policy.enabled ? 'yes' : 'no' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No rules configured yet.</p>
    {% endif %}

    {% if canManagePolicies %}
      <details>
        <summary><strong>Create or update rule</strong></summary>
        <div style="margin-top: 8px;">
          <form method="post" accept-charset="UTF-8" class="js-confirm-form" data-confirm-message="Save this rule?">
            {{ csrfInput() }}
            {{ actionInput('agents/dashboard/upsert-control-policy') }}
            {{ redirectInput('agents/control') }}

            {{ forms.textField({
              label: 'Rule Key',
              instructions: 'Stable machine key for this rule.',
              name: 'handle',
              required: true,
              placeholder: 'returns-exception-high-risk',
            }) }}

            {{ forms.textField({
              label: 'Rule Name',
              name: 'displayName',
              placeholder: 'Returns Exception High Risk',
            }) }}

            {{ forms.textField({
              label: 'Workflow Match Pattern',
              instructions: 'Wildcard pattern, for example: returns.exception.*',
              name: 'actionPattern',
              required: true,
              placeholder: 'returns.exception.*',
            }) }}

            {{ forms.selectField({
              label: 'Impact Level',
              name: 'riskLevel',
              options: [
                {label: 'low', value: 'low'},
                {label: 'medium', value: 'medium'},
                {label: 'high', value: 'high'},
                {label: 'critical', value: 'critical'},
              ],
              value: 'medium',
            }) }}

            <div style="margin-bottom: 8px;">
              <input type="hidden" name="requiresApproval" value="0">
              <label><input type="checkbox" name="requiresApproval" value="1" checked> Needs approval</label>
            </div>

            <div style="margin-bottom: 8px;">
              <input type="hidden" name="enabled" value="0">
              <label><input type="checkbox" name="enabled" value="1" checked> Rule is active</label>
            </div>

            <details style="margin-bottom: 12px;">
              <summary><strong>Advanced Rule JSON</strong></summary>
              <div style="margin-top: 8px;">
                {{ forms.textareaField({
                  label: 'Advanced Config JSON',
                  instructions: 'Optional advanced values, e.g. {"requiredScope":"control:actions:execute"}.',
                  name: 'configJson',
                  rows: 4,
                  value: '{"requiredScope":"control:actions:execute"}',
                }) }}
              </div>
            </details>

            <button class="btn submit" type="submit">Save Rule</button>
          </form>
        </div>
      </details>
    {% else %}
      <p class="warning">You do not have permission to manage rules.</p>
    {% endif %}
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Refund Approval History</h2>
    {% if controlAuditEvents|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Event</th>
          <th>By</th>
          <th>Details</th>
        </tr>
        </thead>
        <tbody>
        {% for event in controlAuditEvents %}
          <tr>
            <td>{{ event.dateCreated ?: 'n/a' }}</td>
            <td><code>{{ event.category }}</code></td>
            <td>{{ event.action }} ({{ event.outcome }})</td>
            <td>{{ event.actorType }} / {{ event.actorId ?: 'n/a' }}</td>
            <td>{{ event.summary ?: 'n/a' }}</td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No history events recorded yet.</p>
    {% endif %}

    <details style="margin-top: 12px;">
      <summary><strong>Raw System Data (Advanced)</strong></summary>
      <pre class="border rounded p-3" style="margin-top: 8px;">{{ controlSnapshotJson }}</pre>
    </details>
  </div>

  {% if canManageApprovals or canExecuteActions or canManagePolicies %}
    {% js %}
      (() => {
        const confirmForms = document.querySelectorAll('.js-confirm-form');
        confirmForms.forEach((form) => {
          form.addEventListener('submit', (event) => {
            const customMessage = form.getAttribute('data-confirm-message') || 'Are you sure?';
            if (!window.confirm(customMessage)) {
              event.preventDefault();
            }
          });
        });

        const executeForm = document.getElementById('control-execute-form');
        if (!executeForm) {
          return;
        }

        const actionTypeInput = document.getElementById('execute-action-type');
        const approvalIdInput = document.getElementById('execute-approval-id');
        const executeButton = document.getElementById('execute-submit');
        const hintNode = document.getElementById('execute-policy-hint');

        if (!actionTypeInput || !approvalIdInput || !executeButton || !hintNode) {
          return;
        }

        const policies = {{ controlPolicies|json_encode|raw }};
        const approvedApprovalsById = {{ controlApprovedApprovalsById|json_encode|raw }};

        const escapeRegex = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const matchesPattern = (actionType, pattern) => {
          if (!pattern || pattern === '*') {
            return true;
          }

          const regex = '^' + pattern.split('*').map(escapeRegex).join('.*') + '$';
          return new RegExp(regex).test(actionType);
        };

        const resolvePolicy = (actionType) => {
          let best = null;
          let bestLen = -1;

          policies.forEach((policy) => {
            const pattern = String(policy.actionPattern || '').trim();
            if (!pattern) {
              return;
            }

            if (!matchesPattern(actionType, pattern)) {
              return;
            }

            if (pattern.length > bestLen) {
              best = policy;
              bestLen = pattern.length;
            }
          });

          if (best) {
            return best;
          }

          return {
            handle: 'default-control-policy',
            riskLevel: 'high',
            requiresApproval: true,
            enabled: true,
          };
        };

        const setExecuteState = () => {
          const actionType = String(actionTypeInput.value || '').trim();
          const approvalIdRaw = String(approvalIdInput.value || '').trim();

          if (!actionType) {
            executeButton.disabled = true;
            hintNode.textContent = 'Enter a refund action name first.';
            executeForm.setAttribute('data-confirm-message', '');
            return;
          }

          const policy = resolvePolicy(actionType);
          const risk = String(policy.riskLevel || 'unknown').toUpperCase();
          const requiresApproval = Boolean(policy.requiresApproval);
          const policyEnabled = Boolean(policy.enabled);

          if (!policyEnabled) {
            executeButton.disabled = true;
            hintNode.textContent = `Rule ${policy.handle || 'default'} is disabled. This run is blocked.`;
            executeForm.setAttribute('data-confirm-message', '');
            return;
          }

          if (requiresApproval) {
            if (!approvalIdRaw) {
              executeButton.disabled = true;
              hintNode.textContent = `Impact ${risk}. This rule needs approval. Enter an approved request number to continue.`;
              executeForm.setAttribute('data-confirm-message', '');
              return;
            }

            const approvalId = Number.parseInt(approvalIdRaw, 10);
            if (!Number.isInteger(approvalId) || !approvedApprovalsById[approvalId]) {
              executeButton.disabled = true;
              hintNode.textContent = `Impact ${risk}. Request number must point to an approved request.`;
              executeForm.setAttribute('data-confirm-message', '');
              return;
            }

            const approvedActionType = String(approvedApprovalsById[approvalId] || '');
            if (approvedActionType !== actionType) {
              executeButton.disabled = true;
              hintNode.textContent = `Impact ${risk}. Request #${approvalId} is for ${approvedActionType}, not ${actionType}.`;
              executeForm.setAttribute('data-confirm-message', '');
              return;
            }
          }

          executeButton.disabled = false;
          hintNode.textContent = `Ready. Impact ${risk}. Approval ${requiresApproval ? 'required and validated' : 'not required'} by rule ${policy.handle || 'default-control-policy'}.`;

          const approvalSegment = requiresApproval
            ? ` Request #${approvalIdRaw} has been validated.`
            : ' This rule does not require approval.';
          executeForm.setAttribute('data-confirm-message', `Run ${actionType} with impact ${risk}?${approvalSegment}`);
        };

        actionTypeInput.addEventListener('input', setExecuteState);
        approvalIdInput.addEventListener('input', setExecuteState);
        setExecuteState();
      })();
    {% endjs %}
  {% endif %}
{% endblock %}
