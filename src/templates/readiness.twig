{% extends "_layouts/cp" %}

{% set title = "Agents Readiness" %}
{% set selectedSubnavItem = "readiness" %}

{% block content %}
  <h1>Readiness</h1>
  <p class="text-sm text-muted">Check if the plugin is ready for agent traffic and see what needs attention.</p>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Service State</h2>
    <p>
      <span class="status {{ agentsEnabled ? 'enabled' : 'disabled' }}"></span>
      <strong>{{ agentsEnabled ? 'Enabled' : 'Disabled' }}</strong>
      <span class="text-muted">(source: {{ agentsEnabledSource == 'env' ? 'environment variable' : 'plugin settings' }})</span>
    </p>
    <p>Overall status: <strong>{{ diagnostics.status|default('unknown') }}</strong></p>
    <p>Readiness score: <strong>{{ diagnostics.readinessScore|default(0) }}</strong> / 100 (ready at {{ diagnostics.thresholdReady|default(50) }}+)</p>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Score Breakdown</h2>
    <table class="data fullwidth">
      <thead>
      <tr>
        <th>Check</th>
        <th>Weight</th>
        <th>Result</th>
        <th>Score</th>
      </tr>
      </thead>
      <tbody>
      {% for criterion in diagnostics.breakdown %}
        <tr>
          <td>{{ criterion.label }}</td>
          <td>{{ criterion.weight }}</td>
          <td>
            <span class="status {{ criterion.passed ? 'enabled' : 'disabled' }}"></span>
            {{ criterion.passed ? 'pass' : 'needs attention' }}
          </td>
          <td>{{ criterion.score }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Component Checks</h2>
    <p><strong>System components</strong></p>
    <ul>
      {% for key, value in diagnostics.componentChecks.systemComponents %}
        <li>{{ key }}: <strong>{{ value ? 'ok' : 'unavailable' }}</strong></li>
      {% endfor %}
    </ul>
    <p><strong>Plugin checks</strong></p>
    <ul>
      {% for key, value in diagnostics.componentChecks.enabledPlugins %}
        <li>{{ key }}: <strong>{{ value ? 'enabled' : 'disabled' }}</strong></li>
      {% endfor %}
    </ul>
  </div>

  {% if diagnostics.warnings|length %}
    <div class="border rounded p-3 warning" style="margin-bottom: 16px;">
      <h2 class="h4">Warnings</h2>
      <ul>
        {% for warning in diagnostics.warnings %}
          <li>{{ warning }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <details>
      <summary><strong>Health Data (Technical JSON)</strong></summary>
      <pre class="border rounded p-3" style="margin-top: 8px;">{{ healthJson }}</pre>
    </details>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <details>
      <summary><strong>Readiness Data (Technical JSON)</strong></summary>
      <pre class="border rounded p-3" style="margin-top: 8px;">{{ readinessJson }}</pre>
    </details>
  </div>

  <div class="border rounded p-3">
    <details>
      <summary><strong>Diagnostics (Technical JSON)</strong></summary>
      <pre class="border rounded p-3" style="margin-top: 8px;">{{ diagnosticsJson }}</pre>
    </details>
  </div>
{% endblock %}
