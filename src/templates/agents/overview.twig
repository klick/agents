{% extends "_layouts/cp" %}

{% set title = "Agents Overview" %}
{% set selectedSubnavItem = "overview" %}
{% import "_includes/forms" as forms %}

{% block content %}
  <h1>Overview</h1>
  <p class="text-sm text-muted">Operational runtime controls and quick links.</p>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Runtime State</h2>
    <p>
      <span class="status {{ agentsEnabled ? 'enabled' : 'disabled' }}"></span>
      <strong>{{ agentsEnabled ? 'Enabled' : 'Disabled' }}</strong>
      <span class="text-muted">(source: {{ agentsEnabledSource == 'env' ? 'environment variable' : 'plugin settings' }})</span>
    </p>
    <form id="agents-enabled-form" method="post" accept-charset="UTF-8">
      {{ csrfInput() }}
      {{ actionInput('agents/dashboard/toggle-enabled') }}
      {{ redirectInput('agents/overview') }}

      {{ forms.lightswitchField({
        id: 'agents-enabled-switch',
        name: 'enabled',
        fieldLabel: 'Agents API',
        instructions: agentsEnabledLocked
          ? 'Controlled by PLUGIN_AGENTS_ENABLED in your environment.'
          : 'Toggle to enable or disable the Agents API.',
        on: agentsEnabled,
        onLabel: 'Enabled',
        offLabel: 'Disabled',
        disabled: agentsEnabledLocked,
      }) }}

      {% if agentsEnabledLocked %}
        <p class="warning">State is locked by <code>PLUGIN_AGENTS_ENABLED</code>.</p>
      {% else %}
        <p class="text-sm text-muted">Saved immediately when toggled.</p>
        <noscript>
          <button class="btn submit" type="submit">Save</button>
        </noscript>
      {% endif %}
    </form>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Operator Actions</h2>
    <form method="post" accept-charset="UTF-8" style="margin-bottom: 8px;">
      {{ csrfInput() }}
      {{ actionInput('agents/dashboard/prewarm-discovery') }}
      {{ redirectInput('agents/overview') }}
      <input type="hidden" name="target" value="all">
      <button class="btn submit" type="submit">Prewarm Discovery (All)</button>
    </form>
    <p><a href="{{ url('agents/discovery') }}">Open Discovery tab for scoped prewarm and cache clear actions</a></p>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Feature Status</h2>
    <ul>
      <li>Discovery `llms.txt`: <strong>{{ discoveryEnabled.llms ? 'enabled' : 'disabled' }}</strong></li>
      <li>Discovery `commerce.txt`: <strong>{{ discoveryEnabled.commerce ? 'enabled' : 'disabled' }}</strong></li>
      <li>Webhook delivery: <strong>{{ webhookEnabled ? 'enabled' : 'disabled' }}</strong></li>
      <li>Security warnings: <strong>{{ securityWarningCounts.warnings|default(0) }}</strong></li>
      <li>Security errors: <strong>{{ securityWarningCounts.errors|default(0) }}</strong></li>
    </ul>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Quick Links</h2>
    <p><strong>API endpoints</strong></p>
    <ul>
      {% for endpoint in apiEndpoints %}
        <li><a href="{{ endpoint }}" target="_blank" rel="noopener">{{ endpoint }}</a></li>
      {% endfor %}
    </ul>
    <p><strong>Discovery endpoints</strong></p>
    <ul>
      {% for endpoint in discoveryEndpoints %}
        <li><a href="{{ endpoint }}" target="_blank" rel="noopener">{{ endpoint }}</a></li>
      {% endfor %}
    </ul>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Ownership Split</h2>
    <table class="data fullwidth">
      <thead>
      <tr>
        <th>Area</th>
        <th>Owner</th>
        <th>Notes</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>Runtime on/off</td>
        <td>CP</td>
        <td>Can be env-locked with <code>PLUGIN_AGENTS_ENABLED</code>.</td>
      </tr>
      <tr>
        <td>Discovery policy/content</td>
        <td><code>config/agents.php</code></td>
        <td>Config-first policy and content ownership.</td>
      </tr>
      <tr>
        <td>Auth and secrets</td>
        <td><code>.env</code></td>
        <td>No secret editing in CP.</td>
      </tr>
      </tbody>
    </table>
  </div>

  <div class="border rounded p-3">
    <h2 class="h4">Readiness Snapshot</h2>
    <p>Status: <strong>{{ readiness.status|default('unknown') }}</strong></p>
    <p>Score: <strong>{{ readiness.readinessScore|default(0) }}</strong> / 100</p>
    <pre class="border rounded p-3">{{ readinessJson }}</pre>
  </div>

  {% if not agentsEnabledLocked %}
    {% js %}
      (() => {
        const form = document.getElementById('agents-enabled-form');
        if (!form) {
          return;
        }
        const switchButton = form.querySelector('button.lightswitch');
        const valueInput = form.querySelector('input[name="enabled"]');
        if (!switchButton || !valueInput) {
          return;
        }

        let previousValue = valueInput.value;
        switchButton.addEventListener('click', () => {
          window.requestAnimationFrame(() => {
            if (valueInput.value === previousValue) {
              return;
            }
            previousValue = valueInput.value;
            if (typeof form.requestSubmit === 'function') {
              form.requestSubmit();
            } else {
              form.submit();
            }
          });
        });
      })();
    {% endjs %}
  {% endif %}
{% endblock %}
