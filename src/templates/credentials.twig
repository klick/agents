{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Agents API Keys" %}
{% set selectedSubnavItem = "credentials" %}
{% set keyExamples = [
  {
    id: 'agent-catalog-sync',
    displayName: 'Catalog Sync Agent',
    description: 'Keeps catalog/content indexes current for search, recommendations, and enrichment.',
    scopes: 'products:read entries:read sections:read changes:read capabilities:read openapi:read',
  },
  {
    id: 'agent-support-ops',
    displayName: 'Support Operations Agent',
    description: 'Reads order + content context to assist support teams during customer conversations.',
    scopes: 'orders:read orders:read_sensitive entries:read entries:read_all_statuses capabilities:read openapi:read',
  },
  {
    id: 'agent-returns-orchestrator',
    displayName: 'Returns Orchestrator Agent',
    description: 'Creates and tracks return/refund requests and follow-up runs (requires return-request feature endpoints).',
    scopes: 'orders:read control:approvals:request control:approvals:read control:executions:read capabilities:read openapi:read',
  },
] %}
{% set availableScopes = [] %}
{% for scope in defaultScopes %}
  {% set normalizedScope = scope|trim %}
  {% if normalizedScope and normalizedScope not in availableScopes %}
    {% set availableScopes = availableScopes|merge([normalizedScope]) %}
  {% endif %}
{% endfor %}
{% for example in keyExamples %}
  {% for scope in example.scopes|split(' ') %}
    {% set normalizedScope = scope|trim %}
    {% if normalizedScope and normalizedScope not in availableScopes %}
      {% set availableScopes = availableScopes|merge([normalizedScope]) %}
    {% endif %}
  {% endfor %}
{% endfor %}
{% set availableScopes = availableScopes|sort %}
{% set scopeOptions = [] %}
{% for scope in availableScopes %}
  {% set scopeOptions = scopeOptions|merge([{ label: scope, value: scope }]) %}
{% endfor %}

{% block content %}
  <h1>API Keys</h1>
  <p class="text-sm text-muted">Create and manage API keys used by agent integrations.</p>

  {% if revealedCredential and revealedCredential.token %}
    <div class="border rounded p-3" style="margin-bottom: 16px; border-color: #d2b48c;">
      <h2 class="h4">Copy Key Now</h2>
      <p>
        Key <code>{{ revealedCredential.handle }}</code>
        was {{ revealedCredential.action }} at
        <strong>{{ revealedCredential.generatedAt }}</strong>.
      </p>
      <p class="warning">This key is only shown once. Store it securely before leaving this page.</p>
      <textarea id="revealedCredentialToken" readonly rows="3" style="width: 100%; font-family: monospace;">{{ revealedCredential.token }}</textarea>
      <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
        <button class="btn" id="copyRevealedCredentialBtn" type="button">Copy key</button>
        <button
          class="btn"
          id="downloadRevealedCredentialBtn"
          type="button"
          data-filename="agents-{{ revealedCredential.handle|replace({':': '-', '/': '-', ' ': '-'}) }}-{{ revealedCredential.generatedAt|replace({':': '', 'T': '-', 'Z': ''}) }}.txt"
        >Download key file</button>
      </div>
      <p id="revealedCredentialFeedback" class="light" style="margin-top: 6px;"></p>
    </div>
  {% endif %}

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Security Summary</h2>
    <ul>
      <li>Token required: <strong>{{ securityPosture.authentication.required ? 'yes' : 'no' }}</strong></li>
      <li>Env credentials: <strong>{{ securityPosture.authentication.envCredentialCount|default(0) }}</strong></li>
      <li>Managed CP keys: <strong>{{ securityPosture.authentication.managedCredentialCount|default(0) }}</strong></li>
      <li>Total active credentials: <strong>{{ securityPosture.authentication.credentialCount|default(0) }}</strong></li>
    </ul>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Typical Agent Examples</h2>
    <p class="light">Use these presets as a starting point, then adjust scopes to your environment.</p>
    <table class="data fullwidth">
      <thead>
      <tr>
        <th>Agent</th>
        <th>Suggested Key ID</th>
        <th>Suggested scopes</th>
        <th>Preset</th>
      </tr>
      </thead>
      <tbody>
      {% for example in keyExamples %}
        <tr>
          <td>
            <strong>{{ example.displayName }}</strong>
            <div class="light">{{ example.description }}</div>
          </td>
          <td><code>{{ example.id }}</code></td>
          <td><code>{{ example.scopes }}</code></td>
          <td>
            {% if canManageCredentials %}
              <button
                type="button"
                class="btn js-apply-key-example"
                data-handle="{{ example.id }}"
                data-display-name="{{ example.displayName }}"
                data-scopes="{{ example.scopes }}"
              >Use preset</button>
            {% else %}
              <span class="light">No edit permission</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <hr>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Create API Key</h2>
    {% if canManageCredentials %}
      <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/create-credential') }}
        {{ redirectInput('agents/credentials') }}

        {{ forms.textField({
          label: 'Key ID',
          instructions: 'Stable identifier used in logs/capabilities (letters, digits, :, _, -, .).',
          id: 'credentialHandle',
          name: 'credentialHandle',
          required: true,
          placeholder: 'integration-ops',
        }) }}

        {{ forms.textField({
          label: 'Display name',
          instructions: 'Human-friendly label.',
          id: 'credentialDisplayName',
          name: 'credentialDisplayName',
          placeholder: 'Operations Integration',
        }) }}

        {{ forms.checkboxSelectField({
          label: 'Scopes',
          instructions: 'Click to add/remove scopes for this key.',
          id: 'credentialScopesSelect',
          name: 'credentialScopes',
          options: scopeOptions,
          values: defaultScopes,
          showAllOption: false,
        }) }}
        <p class="light" id="credentialScopesSummary" style="margin-top: -8px; margin-bottom: 12px;"></p>

        <button class="btn submit" type="submit">Create Key</button>
      </form>
    {% else %}
      <p class="warning">You do not have permission to create or edit API keys.</p>
    {% endif %}
  </div>

  <hr>

  <div class="border rounded p-3">
    <h2 class="h4">Managed API Keys</h2>

    {% if managedCredentials|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>ID</th>
          <th>Display name</th>
          <th>Status</th>
          <th>Scopes</th>
          <th>Last Used</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for credential in managedCredentials %}
          <tr>
            <td>
              <code>{{ credential.handle }}</code><br>
              <span class="light">prefix: {{ credential.tokenPrefix ?: 'n/a' }}</span>
            </td>
            <td>{{ credential.displayName ?: credential.handle }}</td>
            <td>
              {% if credential.revoked %}
                <span class="status disabled"></span>Revoked
              {% else %}
                <span class="status enabled"></span>Active
              {% endif %}
              <br>
              <span class="light">rotated: {{ credential.rotatedAt ?: 'never' }}</span>
            </td>
            <td>
              {% if credential.scopes|length %}
                <code>{{ credential.scopes|join(' ') }}</code>
              {% else %}
                <span class="light">default</span>
              {% endif %}
            </td>
            <td>
              <div>{{ credential.lastUsedAt ?: 'never' }}</div>
              <div class="light">ip: {{ credential.lastUsedIp ?: 'n/a' }}</div>
              <div class="light">method: {{ credential.lastAuthMethod ?: 'n/a' }}</div>
            </td>
            <td>
              {% if canManageCredentials %}
                <form method="post" accept-charset="UTF-8" style="margin-bottom: 8px;">
                  {{ csrfInput() }}
                  {{ actionInput('agents/dashboard/update-credential') }}
                  {{ redirectInput('agents/credentials') }}
                  <input type="hidden" name="credentialId" value="{{ credential.id }}">
                  <input
                    type="text"
                    name="credentialDisplayName"
                    value="{{ credential.displayName ?: credential.handle }}"
                    aria-label="Display name"
                    style="width: 100%; margin-bottom: 4px;"
                  >
                  <textarea
                    name="credentialScopes"
                    rows="2"
                    aria-label="Scopes"
                    style="width: 100%; font-family: monospace; margin-bottom: 4px;"
                  >{{ credential.scopes|join(' ') }}</textarea>
                  <button class="btn" type="submit">Save</button>
                </form>
              {% endif %}

              <div class="agents-managed-key-row-actions">
                {% if canRotateCredentials %}
                  <form method="post" accept-charset="UTF-8">
                    {{ csrfInput() }}
                    {{ actionInput('agents/dashboard/rotate-credential') }}
                    {{ redirectInput('agents/credentials') }}
                    <input type="hidden" name="credentialId" value="{{ credential.id }}">
                    <button class="btn" type="submit">Rotate</button>
                  </form>
                {% endif %}

                {% if canRotateCredentials and not credential.revoked %}
                  <form method="post" accept-charset="UTF-8" onsubmit="return confirm('Revoke current token and issue a new one?');">
                    {{ csrfInput() }}
                    {{ actionInput('agents/dashboard/revoke-and-rotate-credential') }}
                    {{ redirectInput('agents/credentials') }}
                    <input type="hidden" name="credentialId" value="{{ credential.id }}">
                    <button class="btn" type="submit">Revoke + Rotate</button>
                  </form>
                {% endif %}

                {% if canRevokeCredentials and not credential.revoked %}
                  <form method="post" accept-charset="UTF-8">
                    {{ csrfInput() }}
                    {{ actionInput('agents/dashboard/revoke-credential') }}
                    {{ redirectInput('agents/credentials') }}
                    <input type="hidden" name="credentialId" value="{{ credential.id }}">
                    <button class="btn" type="submit">Revoke</button>
                  </form>
                {% endif %}

                {% if canDeleteCredentials %}
                  <form method="post" accept-charset="UTF-8" onsubmit="return confirm('Delete this API key permanently?');">
                    {{ csrfInput() }}
                    {{ actionInput('agents/dashboard/delete-credential') }}
                    {{ redirectInput('agents/credentials') }}
                    <input type="hidden" name="credentialId" value="{{ credential.id }}">
                    <button class="btn" type="submit">Delete</button>
                  </form>
                {% endif %}
              </div>

              {% if not canManageCredentials and not canRotateCredentials and not canRevokeCredentials and not canDeleteCredentials %}
                <span class="light">No actions available.</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No managed API keys yet.</p>
    {% endif %}
  </div>

  {% if canManageCredentials %}
    {% js %}
      (() => {
        const buttons = document.querySelectorAll('.js-apply-key-example');
        const handleInput = document.getElementById('credentialHandle');
        const displayNameInput = document.getElementById('credentialDisplayName');
        const scopeField = document.getElementById('{{ 'credentialScopesSelect'|namespaceInputId }}');
        const summary = document.getElementById('credentialScopesSummary');

        if (!handleInput || !displayNameInput || !scopeField) {
          return;
        }

        const scopeCheckboxes = Array.from(scopeField.querySelectorAll('input[type="checkbox"]'))
          .filter((checkbox) => checkbox.name && checkbox.name.includes('credentialScopes'));
        if (!scopeCheckboxes.length) {
          return;
        }

        const parseScopes = (value) => {
          if (!value) {
            return [];
          }

          const raw = value.split(/[\s,]+/);
          const scopes = [];
          raw.forEach((scope) => {
            const normalized = (scope || '').trim();
            if (!normalized || scopes.includes(normalized)) {
              return;
            }
            scopes.push(normalized);
          });
          return scopes;
        };

        const getSelectedScopes = () => {
          const scopes = [];
          scopeCheckboxes.forEach((checkbox) => {
            if (!checkbox.checked) {
              return;
            }

            const scope = (checkbox.value || '').trim();
            if (!scope || scopes.includes(scope)) {
              return;
            }

            scopes.push(scope);
          });
          return scopes;
        };

        const renderScopeState = () => {
          const selected = getSelectedScopes();

          if (summary) {
            summary.textContent = selected.length
              ? `Selected scopes (${selected.length}): ${selected.join(', ')}`
              : 'No scopes selected. Default read scopes will be used.';
          }
        };

        const applyScopes = (scopesValue) => {
          const selectedScopes = new Set(parseScopes(scopesValue));
          scopeCheckboxes.forEach((checkbox) => {
            const scope = (checkbox.value || '').trim();
            checkbox.checked = selectedScopes.has(scope);
          });
          renderScopeState();
        };

        scopeCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener('change', renderScopeState);
        });

        buttons.forEach((button) => {
          button.addEventListener('click', () => {
            handleInput.value = button.dataset.handle || '';
            displayNameInput.value = button.dataset.displayName || '';
            applyScopes(button.dataset.scopes || '');
            handleInput.focus();
          });
        });

        renderScopeState();
      })();
    {% endjs %}
  {% endif %}

  {% css %}
    .agents-managed-key-row-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .agents-managed-key-row-actions form {
      margin: 0;
    }
  {% endcss %}

  {% if revealedCredential and revealedCredential.token %}
    {% js %}
      (() => {
        const tokenInput = document.getElementById('revealedCredentialToken');
        const copyButton = document.getElementById('copyRevealedCredentialBtn');
        const downloadButton = document.getElementById('downloadRevealedCredentialBtn');
        const feedback = document.getElementById('revealedCredentialFeedback');
        if (!tokenInput) {
          return;
        }

        const setFeedback = (message) => {
          if (feedback) {
            feedback.textContent = message;
          }
        };

        if (copyButton) {
          copyButton.addEventListener('click', async () => {
            const token = tokenInput.value || '';
            if (!token) {
              setFeedback('No key available to copy.');
              return;
            }

            try {
              if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
                await navigator.clipboard.writeText(token);
              } else {
                tokenInput.focus();
                tokenInput.select();
                document.execCommand('copy');
              }
              setFeedback('Key copied to clipboard.');
            } catch (error) {
              setFeedback('Unable to copy automatically. Select the key and copy manually.');
            }
          });
        }

        if (downloadButton) {
          downloadButton.addEventListener('click', () => {
            const token = tokenInput.value || '';
            if (!token) {
              setFeedback('No key available to download.');
              return;
            }

            const filename = downloadButton.dataset.filename || 'agents-api-key.txt';
            const blob = new Blob([token + '\n'], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            URL.revokeObjectURL(url);
            setFeedback('Key file downloaded.');
          });
        }
      })();
    {% endjs %}
  {% endif %}
{% endblock %}
