{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = "Agents Credentials" %}
{% set selectedSubnavItem = "credentials" %}

{% block content %}
  <h1>Credentials</h1>
  <p class="text-sm text-muted">Manage CP-controlled API credentials with rotate/revoke lifecycle and last-used visibility.</p>

  {% if revealedCredential and revealedCredential.token %}
    <div class="border rounded p-3" style="margin-bottom: 16px; border-color: #d2b48c;">
      <h2 class="h4">Copy Token Now</h2>
      <p>
        Credential <code>{{ revealedCredential.handle }}</code>
        was {{ revealedCredential.action }} at
        <strong>{{ revealedCredential.generatedAt }}</strong>.
      </p>
      <p class="warning">This token is only shown once. Store it securely before leaving this page.</p>
      <textarea readonly rows="3" style="width: 100%; font-family: monospace;">{{ revealedCredential.token }}</textarea>
    </div>
  {% endif %}

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Auth Posture</h2>
    <ul>
      <li>Token required: <strong>{{ securityPosture.authentication.required ? 'yes' : 'no' }}</strong></li>
      <li>Env credentials: <strong>{{ securityPosture.authentication.envCredentialCount|default(0) }}</strong></li>
      <li>Managed CP credentials: <strong>{{ securityPosture.authentication.managedCredentialCount|default(0) }}</strong></li>
      <li>Total active credentials: <strong>{{ securityPosture.authentication.credentialCount|default(0) }}</strong></li>
    </ul>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Create Managed Credential</h2>
    <form method="post" accept-charset="UTF-8">
      {{ csrfInput() }}
      {{ actionInput('agents/dashboard/create-credential') }}
      {{ redirectInput('agents/credentials') }}

      {{ forms.textField({
        label: 'Credential ID',
        instructions: 'Stable identifier used in logs/capabilities (letters, digits, :, _, -, .).',
        id: 'credentialHandle',
        name: 'credentialHandle',
        required: true,
        placeholder: 'integration-ops',
      }) }}

      {{ forms.textField({
        label: 'Display Name',
        instructions: 'Human-friendly operator label.',
        id: 'credentialDisplayName',
        name: 'credentialDisplayName',
        placeholder: 'Operations Integration',
      }) }}

      {{ forms.textareaField({
        label: 'Scopes',
        instructions: 'Comma or space separated. Leave blank to use default read scopes.',
        id: 'credentialScopes',
        name: 'credentialScopes',
        rows: 3,
        value: defaultScopes|join(' '),
      }) }}

      <button class="btn submit" type="submit">Create Credential</button>
    </form>
  </div>

  <div class="border rounded p-3">
    <h2 class="h4">Managed Credentials</h2>

    {% if managedCredentials|length %}
      <table class="data fullwidth">
        <thead>
        <tr>
          <th>ID</th>
          <th>Display Name</th>
          <th>Status</th>
          <th>Scopes</th>
          <th>Last Used</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        {% for credential in managedCredentials %}
          <tr>
            <td>
              <code>{{ credential.handle }}</code><br>
              <span class="light">prefix: {{ credential.tokenPrefix ?: 'n/a' }}</span>
            </td>
            <td>{{ credential.displayName ?: credential.handle }}</td>
            <td>
              {% if credential.revoked %}
                <span class="status disabled"></span>Revoked
              {% else %}
                <span class="status enabled"></span>Active
              {% endif %}
              <br>
              <span class="light">rotated: {{ credential.rotatedAt ?: 'never' }}</span>
            </td>
            <td>
              {% if credential.scopes|length %}
                <code>{{ credential.scopes|join(' ') }}</code>
              {% else %}
                <span class="light">default</span>
              {% endif %}
            </td>
            <td>
              <div>{{ credential.lastUsedAt ?: 'never' }}</div>
              <div class="light">ip: {{ credential.lastUsedIp ?: 'n/a' }}</div>
              <div class="light">method: {{ credential.lastAuthMethod ?: 'n/a' }}</div>
            </td>
            <td>
              <form method="post" accept-charset="UTF-8" style="margin-bottom: 8px;">
                {{ csrfInput() }}
                {{ actionInput('agents/dashboard/rotate-credential') }}
                {{ redirectInput('agents/credentials') }}
                <input type="hidden" name="credentialId" value="{{ credential.id }}">
                <button class="btn" type="submit">Rotate</button>
              </form>

              {% if not credential.revoked %}
                <form method="post" accept-charset="UTF-8">
                  {{ csrfInput() }}
                  {{ actionInput('agents/dashboard/revoke-credential') }}
                  {{ redirectInput('agents/credentials') }}
                  <input type="hidden" name="credentialId" value="{{ credential.id }}">
                  <button class="btn" type="submit">Revoke</button>
                </form>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No managed credentials yet.</p>
    {% endif %}
  </div>
{% endblock %}
