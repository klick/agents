{% extends "_layouts/cp" %}

{% set title = "Agents Discovery" %}
{% set selectedSubnavItem = "discovery" %}

{% block content %}
  <h1>Discovery</h1>
  <p class="text-sm text-muted">Status and cache controls for <code>llms.txt</code> and <code>commerce.txt</code>.</p>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Service State</h2>
    <p>
      <span class="status {{ agentsEnabled ? 'enabled' : 'disabled' }}"></span>
      <strong>{{ agentsEnabled ? 'Enabled' : 'Disabled' }}</strong>
      <span class="text-muted">(source: {{ agentsEnabledSource == 'env' ? 'environment variable' : 'plugin settings' }})</span>
    </p>
  </div>

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Quick Actions</h2>
    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px;">
      <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/prewarm-discovery') }}
        {{ redirectInput('agents/discovery') }}
        <input type="hidden" name="target" value="all">
        <button class="btn submit" type="submit">Refresh All</button>
      </form>
      <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/prewarm-discovery') }}
        {{ redirectInput('agents/discovery') }}
        <input type="hidden" name="target" value="llms">
        <button class="btn" type="submit">Refresh llms.txt</button>
      </form>
      <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/prewarm-discovery') }}
        {{ redirectInput('agents/discovery') }}
        <input type="hidden" name="target" value="commerce">
        <button class="btn" type="submit">Refresh commerce.txt</button>
      </form>
      <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        {{ actionInput('agents/dashboard/clear-discovery-cache') }}
        {{ redirectInput('agents/discovery') }}
        <button class="btn" type="submit">Clear cache</button>
      </form>
    </div>
    <p class="text-sm text-muted">These actions only refresh generated discovery files and cache state. Content policy still comes from config.</p>
  </div>

  {% for key, document in discoveryStatus.documents %}
    <div class="border rounded p-3" style="margin-bottom: 16px;">
      <h2 class="h4">{{ document.name }}</h2>
      <p>
        <span class="status {{ document.enabled ? 'enabled' : 'disabled' }}"></span>
        <strong>{{ document.enabled ? 'Enabled' : 'Disabled' }}</strong>
        <span class="text-muted">({{ document.path }})</span>
      </p>
      <table class="data fullwidth" style="margin-bottom: 8px;">
        <tbody>
        <tr><th>URL</th><td><a href="{{ document.url }}" target="_blank" rel="noopener">{{ document.url }}</a></td></tr>
        <tr><th>Cache TTL</th><td>{{ document.cacheTtlSeconds }} seconds</td></tr>
        <tr><th>ETag</th><td>{{ document.etag ?: 'n/a' }}</td></tr>
        <tr><th>Last Modified</th><td>{{ document.lastModified ?: 'n/a' }}</td></tr>
        <tr><th>Bytes</th><td>{{ document.bytes }}</td></tr>
        <tr><th>Lines</th><td>{{ document.lineCount }}</td></tr>
        </tbody>
      </table>
      <h3>Preview</h3>
      <pre class="border rounded p-3">{{ document.preview ?: '# Disabled' }}</pre>
    </div>
  {% endfor %}

  <div class="border rounded p-3" style="margin-bottom: 16px;">
    <h2 class="h4">Where to change what</h2>
    <ul>
      <li>Use <code>config/agents.php</code> for discovery content and policy.</li>
      <li>Use this CP tab for cache refresh/clear and status checks.</li>
      <li>Do not edit secrets in CP.</li>
    </ul>
  </div>

  <div class="border rounded p-3">
    <details>
      <summary><strong>Discovery Status (Technical JSON)</strong></summary>
      <pre class="border rounded p-3" style="margin-top: 8px;">{{ discoveryStatusJson }}</pre>
    </details>
  </div>
{% endblock %}
